<div class="product-card__media ">
{% comment %}
    <div class="--custom-badge-wrapper {% if collection.metafields.custom.is_sale_collection == true  %} hidden {% endif %}">
    {% if product.metafields.custom.product_badge.value %}
        {% for badge in product.metafields.custom.product_badge.value limit: 2 %}
        <span class="--single-badge">
            {% if forloop.last %}
            <a href="{{ product.url }}">{{ badge | strip | escape }}</a>
            {% else %}
            <a href="{{ product.url }}">{{ badge | strip | escape }}</a>
            {% endif %}
        </span>
        {% endfor %}
    {% endif %}
    </div>
{% endcomment %}


{% comment %} {% assign first_color_value = '' %}
{% if product.options_by_name.Color %}
    {% assign first_color_value = product.options_by_name.Color.values.first %}
{% endif %} {% endcomment %}
{% assign first_color_value = product.selected_or_first_available_variant.options[0] %}



{% assign matched_media = product.media | where: 'alt', first_color_value %}
{% assign first_variant_with_image = product.variants | where: 'featured_image' | first %}
{% assign media_index = 0 %}
{% if first_variant_with_image %}
    {% for m in product.media %}
    {% if m.id == first_variant_with_image.featured_image.id %}
        {% assign media_index = forloop.index0 %}
        {% break %}
    {% endif %}
    {% endfor %}
{% endif %}
{% assign next_index = media_index | plus: 1 %}
<a
    href="{{ product.selected_or_first_available_variant.url | within: collection }}"
    class="
    product-card__image-link js-product-link {% if first_color_value != '' and matched_media.size > 1 %}
        has-multiple-media
    {% elsif matched_media.size == 0 and first_variant_with_image and product.media.size > next_index %}
        has-multiple-media-reverse
    {% endif %}
    "
>
    {% if first_color_value != '' and matched_media.size > 0 %}
    {% assign first_media = matched_media.first %}
    {% assign variant_for_media = product.variants | where: 'featured_image', first_media | first %}
    {{
        first_media
        | image_url: width: 600
        | image_tag:
        class: 'product-card__primary-image',
        loading: 'lazy',
        widths: '300, 400, 500, 600',
        sizes: '(max-width: 767px) 100vw, 50vw'
    }}
    {% elsif matched_media.size == 0 and first_variant_with_image %}
    {% if product.media.size > next_index %}
        {% assign first_media = product.media[next_index] %}
        {{
        first_media
        | image_url: width: 600
        | image_tag:
            class: 'product-card__primary-image',
            loading: 'lazy',
            widths: '300, 400, 500, 600',
            sizes: '(max-width: 767px) 100vw, 50vw'
        }}
    {% endif %}
    {% endif %}
</a>

<div
    class="
    product-card__gallery swiper-container--lazy {% if first_color_value != '' and matched_media.size > 1 %}
        has-multiple-media
    {% elsif matched_media.size == 0 and first_variant_with_image and product.media.size > next_index %}
        has-multiple-media-reverse
    {% endif %}
    "
    data-media-count="{{ product.media.size }}"
    {% if first_color_value != '' and matched_media.size > 1 %}
    data-start="1"
    {% endif %}
    aria-hidden="true"
>
    <div class="swiper">
    <div class="swiper-wrapper">
        {% if first_color_value != '' %}
        {% if matched_media.size > 0 %}
            {% for media in matched_media %}
            {% assign variant_for_media = product.variants | where: 'featured_image', media | first %}
            <div
                class="swiper-slide {% if forloop.first %}first-swiper-slide{% elsif forloop.index == 2 %}second-swiper-slide{% endif %}"
                data-media-id="{{ media.id }}"
                data-media-position="{{ forloop.index }}"
                data-variant-id="{{ variant_for_media.id | default: '' }}"
            >
                {% comment %} <a href="{% if variant_for_media %}{{ product.url }}?variant={{ variant_for_media.id }}{% elsif product.variants.size > 0 %}{{ product.url }}?variant={{ product.selected_or_first_available_variant.id }}{% else %}{{ product.url }}{% endif %}"> {% endcomment %}
                <a href="{{ product.selected_or_first_available_variant.url | within: collection }}">
                {{
                    media
                    | image_url: width: 600
                    | image_tag:
                    class: 'product-card__gallery-image swiper-lazy',
                    loading: 'lazy',
                    widths: '300, 400, 500, 600',
                    sizes: '(max-width: 767px) 100vw, 50vw'
                }}
                </a>
            </div>
            {% endfor %}
        {% else %}
            {% assign first_variant_with_image = product.variants | where: 'featured_image' | first %}
            {% if first_variant_with_image %}
            {% assign media = first_variant_with_image.featured_image %}
            <div
                class="swiper-slide first-swiper-slide"
                data-media-id="{{ media.id }}"
                data-media-position="1"
                data-variant-id="{{ first_variant_with_image.id }}"
            >
                {% comment %} <a href="{{ product.url }}?variant={{ first_variant_with_image.id }}"> {% endcomment %}
                <a href="{{ product.selected_or_first_available_variant.url | within: collection }}">
                {{
                    media
                    | image_url: width: 600
                    | image_tag:
                    class: 'product-card__gallery-image swiper-lazy',
                    loading: 'lazy',
                    widths: '300, 400, 500, 600',
                    sizes: '(max-width: 767px) 100vw, 50vw'
                }}
                </a>
            </div>
            {% else %}
            {% assign media = product.media.first %}
            <div
                class="swiper-slide first-swiper-slide"
                data-media-id="{{ media.id }}"
                data-media-position="1"
                data-variant-id="{{ product.selected_or_first_available_variant.id | default: '' }}"
            >
                {% comment %} <a href="{% if product.variants.size > 0 %}{{ product.url }}?variant={{ product.selected_or_first_available_variant.id }}{% else %}{{ product.url }}{% endif %}"> {% endcomment %}
                <a href="{{ product.selected_or_first_available_variant.url | within: collection }}">
                {{
                    media
                    | image_url: width: 600
                    | image_tag:
                    class: 'product-card__gallery-image swiper-lazy',
                    loading: 'lazy',
                    widths: '300, 400, 500, 600',
                    sizes: '(max-width: 767px) 100vw, 50vw'
                }}
                </a>
            </div>
            {% endif %}
        {% endif %}
        {% else %}
        {% assign media = product.media.first %}
        <div
            class="swiper-slide first-swiper-slide"
            data-media-id="{{ media.id }}"
            data-media-position="1"
            data-variant-id="{{ product.selected_or_first_available_variant.id | default: '' }}"
        >
            {% comment %} <a href="{% if product.variants.size > 0 %}{{ product.url }}?variant={{ product.selected_or_first_available_variant.id }}{% else %}{{ product.url }}{% endif %}"> {% endcomment %}
            <a href="{{ product.selected_or_first_available_variant.url | within: collection }}">
            {{
                media
                | image_url: width: 600
                | image_tag:
                class: 'product-card__gallery-image swiper-lazy',
                loading: 'lazy',
                widths: '300, 400, 500, 600',
                sizes: '(max-width: 767px) 100vw, 50vw'
            }}
            </a>
        </div>
        {% endif %}
    </div>
    <div class="swiper-pagination"></div>
    <button class="swiper-button-prev">{% render 'card-icons', name: 'prev' %}</button>
    <button class="swiper-button-next">{% render 'card-icons', name: 'next' %}</button>
    </div>
</div>

</div>